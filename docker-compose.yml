version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: epanen-backend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # AI
      - AI_API_URL=${AI_API_URL}
      - AI_API_KEY=${AI_API_KEY}
      - AI_MODEL=${AI_MODEL}
      - AI_MAX_TOKENS=${AI_MAX_TOKENS:-2000}
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      # Frontend URL for CORS
      - FRONTEND_URL=${FRONTEND_URL}
    networks:
      - epanen-network
    # depends_on:
    #   - postgres # Removed - using Supabase cloud

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: epanen-frontend
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    # volumes:
    #   # Mount SSL certificates for HTTPS (uncomment when SSL is set up)
    #   - ./frontend/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
    networks:
      - epanen-network
    environment:
      - VITE_API_BASE=/api

  # PostgreSQL (Only needed if NOT using Supabase cloud)
  postgres:
    image: postgres:15-alpine
    container_name: epanen-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=epanen
      - POSTGRES_USER=epanen
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-epanen123}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - epanen-network
    # Comment this service if using Supabase cloud
    profiles:
      - local

networks:
  epanen-network:
    driver: bridge

volumes:
  postgres_data:
